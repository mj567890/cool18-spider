cool18-spider「多线程优化版本」
===================================
多线程优化版本：cool18-spider-threaded.py
原始同步版本：cool18-spider.py

说明：
-----
本版本是基于原始同步版本的多线程优化改进，主要特点是使用线程池并发技术，
显著提升抓取性能，同时保持程序的稳定性和易用性。

核心特性：
---------
1. 【多层次并发优化】
   - 小说列表页面：多本小说同时下载
   - 内链章节：同一小说的多个章节并行抓取
   - tid递增模式：批量并行检查连续章节

2. 【性能优化】
   - 使用ThreadPoolExecutor线程池管理
   - Session连接复用，减少连接开销
   - 批量处理，减少单次请求延迟
   - 可配置线程数和延迟参数

3. 【线程安全】
   - 文件写入锁：确保多线程文件操作安全
   - 打印锁：避免控制台输出混乱
   - 全局Session：线程安全的HTTP会话

4. 【智能配置】
   - 默认8个工作线程，可动态调整
   - 自适应延迟：0.2-0.5秒随机延迟
   - 连接池优化：20个连接复用

性能对比：
---------
相比同步版本：
- 内链章节抓取：提速3-8倍（取决于章节数量）
- 多本小说下载：提速2-4倍（取决于网络条件）
- 整体效率：平均提升2-5倍

使用建议：
---------
1. 【网络环境】
   - 建议在稳定网络环境下使用
   - 如遇频繁超时，可适当减少线程数
   - 网络较慢时建议增加延迟范围

2. 【系统资源】
   - 默认配置适合大多数环境
   - 高性能机器可适当增加线程数（最大建议16）
   - 内存占用会比同步版本略高

3. 【异常处理】
   - 内置重试机制，自动处理临时网络问题
   - 失败的小说会跳过，不影响其他下载
   - 程序意外中断时，临时列表会保留进度

注意事项：
---------
- 请合理设置线程数，避免对目标网站造成过大压力
- 建议首次使用时使用默认配置
- 如遇反爬虫限制，请适当降低并发数和增加延迟

版本信息：
---------
基于原始同步版本改进
优化目标：提升性能、保持稳定、易于使用
适用场景：批量下载、快速更新、日常使用

---
cool18-spider 1.0 功能与特点一览
多线程优化版本：cool18-spider-threaded.py
原始同步版本(1.0)：cool18-spider.py
（一句话：零配置、一键把「cool18 禁忌书屋」整站小说拖回本地，自动去噪、自动排版、自动管理更新）

---

一、核心功能
1. 整站索引  
   - 按黄金页（gold 页）逐页扫描，自动去重、自动翻页，可限定页数。  
2. 双模式下载  
   - 更新模式：只下「新书上架」与「旧书补章」。  
   - 旧书补全模式：把主列表里缺章的小说一次性补完。  
3. 章节获取策略  
   - 优先解析内链：检测到章节导航时，按源码出现顺序倒序抓取（保持连贯）。  
   - tid 自增兜底：无内链时自动 tid++，发现前缀变化再给 3 次容错，连续 3 次不一致才终止，避免偶发跳章。  
4. 内容净化（全部自动完成）  
   - 内链标题仅做日志提示，成书前全部删除，杜绝无用链接文字。  
   - 连续 2+ 半角/全角空格 → 硬回车+对应空格，保留原排版意图。  
   - 删除所有半角/全角空格、删除纯空段（仅回车的段）。  
   - 每段自动加两个全角空格，符合中文纸质书排版习惯。  
5. 列表管理  
   - 首次运行自动生成「正式列表」+「临时列表」；每次更新先写临时，结束后合并，支持断点续抓。  
6. 断点续传 & 重试  
   - 单章 3 次网络重试；404/跳转自动跳过；中段失败下次启动自动续传。  
7. 零依赖绿色版  
   - 标准库 + requests 即可运行，Windows 自带 UTF-8 控制台，开箱即用。

---

二、细节特点
- 不落地内链标题：抓取时记录标题仅用于日志，合并后统一 `replace` 删除，正文绝对干净。  
- 3 级容错 tid 递增：中间只要出现 1 次前缀恢复即清零计数，大幅减少误断。  
- 段落级清洗管线

  去空格 → 去空段 → 加段首空格，三步一次完成，不破坏原有换车逻辑。  
- 源码倒序抓内链：保证“最新章节”排在文件最末，符合阅读习惯。  
- 全程中文日志：每本书、每章节实时提示当前进度与失败原因。  
- 可拓展：`clean_final()` 函数独立，可二次开发添加更多排版规则。

---

三、输出规格
- 文件编码：UTF-8（带 BOM）  
- 文件名：`{书名}.txt`，自动过滤非法字符  
- 内容示例

　　第一章穿越伊始

　　……

　　第二百章大结局  

---

四、使用方式
1. 安装依赖

   pip install requests  
2. 运行

   python cool18_spider.py  
3. 菜单选择

   1 更新小说 → 2 补全旧书 → 0 退出  
4. 结果

   当前目录自动生成 output/ 与 list/，小说全量保存至 output。

---

五、版本计划
- 1.x 稳定版：修复偶发编码、适配站点微调。  
- 2.0 预览版：支持多线程、增量仅抓最新缺失章、EPUB 自动打包。  

—— 至此，cool18-spider 1.0 全部交付，祝阅读愉快！
